<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  background: transparent;
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  color: #e8e8f0;
  overflow: hidden;
}

:root {
  --bg: rgba(14, 14, 30, 0.92);
  --bg-card: rgba(26, 26, 60, 0.8);
  --border: rgba(60, 60, 120, 0.4);
  --accent: #6c5ce7;
  --text-dim: #8888aa;
}

.dashboard {
  height: 100%;
  background: var(--bg);
  backdrop-filter: blur(30px);
  border-radius: 20px;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 25px 60px rgba(0,0,0,0.6);
}

/* â”€â”€â”€ Header â”€â”€â”€ */
.dash-header {
  padding: 16px 20px 0;
  -webkit-app-region: drag;
  flex-shrink: 0;
}

.dash-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.close-btn {
  -webkit-app-region: no-drag;
  width: 28px; height: 28px;
  border-radius: 50%;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-dim);
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.close-btn:hover { background: rgba(231,76,60,0.3); color: #e74c3c; }

/* í”„ë¡œí•„ ì˜ì—­ */
.profile-section {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 0 0 16px;
  border-bottom: 1px solid var(--border);
  -webkit-app-region: no-drag;
}

.profile-avatar {
  width: 64px; height: 64px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.15);
  flex-shrink: 0;
  overflow: hidden;
  background: rgba(20,20,40,0.8);
}

.profile-avatar svg { width: 52px; height: 52px; }

.profile-info { flex: 1; }
.profile-name { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
.profile-role { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; }

.profile-status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.profile-status.working { background: rgba(0,184,148,0.15); color: #00b894; }
.profile-status.resting { background: rgba(253,203,110,0.15); color: #fdcb6e; }
.profile-status.vacation { background: rgba(225,112,85,0.15); color: #e17055; }

.status-dot-sm {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* â”€â”€â”€ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€â”€ */
.dash-tabs {
  display: flex;
  padding: 12px 20px 0;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  -webkit-app-region: no-drag;
}

.dtab {
  padding: 8px 16px;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  font-family: inherit;
}

.dtab:hover { color: #e8e8f0; }
.dtab.active { color: #e8e8f0; border-bottom-color: var(--accent); }

/* â”€â”€â”€ íƒ­ ì»¨í…ì¸  â”€â”€â”€ */
.tab-content {
  flex: 1;
  overflow-y: auto;
  display: none;
}

.tab-content.active { display: flex; flex-direction: column; }

/* â”€â”€â”€ í˜ë¥´ì†Œë‚˜/ìŠ¤í‚¬ íƒ­ â”€â”€â”€ */
.persona-tab {
  padding: 16px 20px;
}

.field-group {
  margin-bottom: 16px;
}

.field-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.field-textarea {
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  color: #e8e8f0;
  font-size: 12px;
  font-family: inherit;
  resize: vertical;
  outline: none;
  line-height: 1.5;
  min-height: 60px;
}

.field-textarea:focus { border-color: var(--accent); }

.field-input {
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  color: #e8e8f0;
  font-size: 12px;
  font-family: inherit;
  outline: none;
}

.field-input:focus { border-color: var(--accent); }

/* ìŠ¤í‚¬ íƒœê·¸ */
.skill-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}

.skill-tag {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  font-size: 11px;
  color: #e8e8f0;
}

.skill-tag .remove {
  cursor: pointer;
  color: var(--text-dim);
  font-size: 14px;
  line-height: 1;
}

.skill-tag .remove:hover { color: #e74c3c; }

.add-skill-row {
  display: flex;
  gap: 6px;
}

.add-skill-row input {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  color: #e8e8f0;
  font-size: 11px;
  outline: none;
}

.add-skill-row button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 11px;
  cursor: pointer;
}

/* ëŠ¥ë ¥ì¹˜ ë°” */
.stat-bars {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.stat-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.stat-label {
  width: 60px;
  font-size: 11px;
  color: var(--text-dim);
}

.stat-bar-bg {
  flex: 1;
  height: 6px;
  background: rgba(255,255,255,0.06);
  border-radius: 3px;
  overflow: hidden;
}

.stat-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}

.stat-value {
  font-size: 11px;
  font-weight: 600;
  width: 30px;
  text-align: right;
}

/* â”€â”€â”€ ì±„íŒ… íƒ­ â”€â”€â”€ */
.chat-tab {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.msg {
  max-width: 82%;
  animation: fadeIn 0.25s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.user { align-self: flex-end; }
.msg.bot { align-self: flex-start; }

.msg-bubble {
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 13px;
  line-height: 1.5;
  word-break: break-word;
  white-space: pre-wrap;
}

.msg.user .msg-bubble {
  background: var(--accent);
  border-bottom-right-radius: 4px;
}

.msg.bot .msg-bubble {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.msg-time {
  font-size: 9px;
  color: var(--text-dim);
  margin-top: 3px;
  padding: 0 4px;
}

.msg.user .msg-time { text-align: right; }

.typing-msg .msg-bubble {
  display: flex;
  gap: 4px;
  padding: 12px 18px;
}

.typing-msg span {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--text-dim);
  animation: typeDot 1.4s infinite;
}

.typing-msg span:nth-child(2) { animation-delay: 0.2s; }
.typing-msg span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typeDot {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
  30% { transform: translateY(-5px); opacity: 1; }
}

.chat-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-dim);
  font-size: 13px;
  text-align: center;
  padding: 20px;
  line-height: 1.6;
}

/* ì…ë ¥ ì˜ì—­ */
.chat-input-area {
  padding: 10px 16px 14px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  align-items: flex-end;
  flex-shrink: 0;
}

.attach-btn {
  width: 38px; height: 38px;
  border-radius: 50%;
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--border);
  color: var(--text-dim);
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}

.attach-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

.attach-menu {
  position: absolute;
  bottom: 60px;
  left: 16px;
  background: rgba(20,20,45,0.98);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 6px;
  display: none;
  flex-direction: column;
  z-index: 50;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
}

.attach-menu.show { display: flex; }

.attach-menu button {
  background: none;
  border: none;
  color: #e8e8f0;
  padding: 10px 14px;
  text-align: left;
  cursor: pointer;
  border-radius: 8px;
  font-size: 12px;
  font-family: inherit;
  display: flex;
  align-items: center;
  gap: 8px;
}

.attach-menu button:hover { background: rgba(108,92,231,0.2); }

.attachments-preview {
  padding: 8px 16px;
  border-top: 1px solid var(--border);
  display: none;
  flex-wrap: wrap;
  gap: 6px;
  background: rgba(0,0,0,0.2);
}

.attachments-preview.has-items { display: flex; }

.attachment-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  font-size: 11px;
}

.attachment-chip .remove-attach {
  background: none;
  border: none;
  color: #e74c3c;
  cursor: pointer;
  font-size: 12px;
  padding: 0;
  line-height: 1;
}

.hidden-file-input { display: none; }

.chat-input {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 10px 14px;
  color: #e8e8f0;
  font-size: 13px;
  font-family: inherit;
  resize: none;
  outline: none;
  max-height: 100px;
  line-height: 1.4;
}

.chat-input:focus { border-color: var(--accent); }

.send-btn {
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}

.send-btn:hover { background: #7c6cf7; transform: scale(1.05); }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* API ëª¨ë‹¬ */
.api-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  border-radius: 20px;
}

.api-modal {
  background: rgba(20,20,45,0.95);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 30px;
  width: 85%;
  max-width: 350px;
  text-align: center;
}

.api-modal h3 { margin-bottom: 8px; font-size: 16px; }
.api-modal p { font-size: 12px; color: var(--text-dim); margin-bottom: 16px; }

.api-modal input {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: #e8e8f0;
  font-size: 13px;
  outline: none;
  margin-bottom: 12px;
}

.api-modal button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 10px 28px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

/* ìŠ¤í¬ë¡¤ë°” */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* ìƒíƒœ ë³€ê²½ ë©”ë‰´ */
.status-menu-popup {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 4px;
  background: rgba(20,20,45,0.95);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  z-index: 50;
  display: none;
}

.status-menu-popup.show { display: block; }

.status-menu-popup button {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  padding: 8px 14px;
  background: none;
  border: none;
  color: #e8e8f0;
  font-size: 12px;
  cursor: pointer;
  font-family: inherit;
}

.status-menu-popup button:hover { background: rgba(108,92,231,0.2); }
</style>
</head>
<body>
<div class="dashboard" id="dashboard">
  <!-- API í‚¤ ëª¨ë‹¬ -->
  <div class="api-overlay" id="api-overlay" style="display:none;">
    <div class="api-modal" style="position:relative;">
      <button onclick="document.getElementById('api-overlay').style.display='none'" style="position:absolute;top:10px;right:14px;background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;padding:4px;">âœ•</button>
      <h3>API Key ì„¤ì •</h3>
      <p>Claude API í‚¤ë¥¼ ì…ë ¥í•˜ë©´<br>ì§ì›ë“¤ì´ ì¼ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
      <input type="password" id="api-key-input" placeholder="sk-ant-api03-..." />
      <button onclick="submitApiKey()">í™•ì¸</button>
    </div>
  </div>

  <!-- í—¤ë” -->
  <div class="dash-header">
    <div class="dash-header-row">
      <span style="font-size:13px; font-weight:600; color:var(--text-dim)">AI Office</span>
      <button class="close-btn" onclick="api.closeDashboard()">âœ•</button>
    </div>
    <div class="profile-section" id="profile-section"></div>
  </div>

  <!-- íƒ­ -->
  <div class="dash-tabs">
    <button class="dtab active" data-tab="chat" onclick="switchTab('chat')">ì±„íŒ…</button>
    <button class="dtab" data-tab="persona" onclick="switchTab('persona')">í˜ë¥´ì†Œë‚˜</button>
    <button class="dtab" data-tab="skills" onclick="switchTab('skills')">ëŠ¥ë ¥/ìŠ¤í‚¬</button>
  </div>

  <!-- ì±„íŒ… íƒ­ -->
  <div class="tab-content active" id="tab-chat">
    <div class="chat-tab">
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty">ì§ì›ì„ ì„ íƒí•˜ê³ <br>ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
      </div>
      <div class="attachments-preview" id="attachments-preview"></div>
      <div class="chat-input-area" style="position:relative;">
        <div class="attach-menu" id="attach-menu">
          <button onclick="triggerFileInput('image')">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
          <button onclick="triggerFileInput('document')">ğŸ“„ ë¬¸ì„œ</button>
          <button onclick="addTextAttachment()">ğŸ“ í…ìŠ¤íŠ¸ ë©”ëª¨</button>
        </div>
        <button class="attach-btn" onclick="toggleAttachMenu()">ğŸ“</button>
        <textarea class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()">â†‘</button>
      </div>
      <input type="file" class="hidden-file-input" id="file-input" onchange="handleFileSelect(event)">
    </div>
  </div>

  <!-- í˜ë¥´ì†Œë‚˜ íƒ­ -->
  <div class="tab-content" id="tab-persona">
    <div class="persona-tab">
      <div class="field-group">
        <div class="field-label">ì„±ê²© & ë§íˆ¬</div>
        <textarea class="field-textarea" id="persona-personality" rows="3" placeholder="ì˜ˆ: ë“ ë“ í•œ í˜• ê°™ì€ ìŠ¤íƒ€ì¼, ë°˜ë§ì„ ì”ë‹ˆë‹¤..."></textarea>
      </div>
      <div class="field-group">
        <div class="field-label">ì „ë¬¸ ë¶„ì•¼</div>
        <textarea class="field-textarea" id="persona-expertise" rows="3" placeholder="ì˜ˆ: ë…¸ë™ë²•, ì¸ì‚¬ê´€ë¦¬, ì·¨ì—…ê·œì¹™..."></textarea>
      </div>
      <div class="field-group">
        <div class="field-label">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ê³ ê¸‰)</div>
        <textarea class="field-textarea" id="persona-system" rows="5" placeholder="AIì—ê²Œ ì „ë‹¬ë˜ëŠ” ì „ì²´ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸..."></textarea>
      </div>
    </div>
  </div>

  <!-- ëŠ¥ë ¥/ìŠ¤í‚¬ íƒ­ -->
  <div class="tab-content" id="tab-skills">
    <div class="persona-tab">
      <div class="field-group">
        <div class="field-label">ëŠ¥ë ¥ì¹˜</div>
        <div class="stat-bars" id="stat-bars"></div>
      </div>
      <div class="field-group">
        <div class="field-label">ë³´ìœ  ìŠ¤í‚¬</div>
        <div class="skill-tags" id="skill-tags"></div>
        <div class="add-skill-row">
          <input id="new-skill-input" placeholder="ìŠ¤í‚¬ ì¶”ê°€..." />
          <button onclick="addSkill()">+</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="characters.js"></script>
<script>
  // â”€â”€â”€ State â”€â”€â”€
  let currentEmployee = null;
  let employees = [];
  let chatHistories = {};  // id -> [{role, text}]
  let employeePersonas = {}; // id -> {personality, expertise, system, skills, stats}
  let isLoading = false;
  let attachments = [];
  let currentFileType = 'document';

  // ê¸°ë³¸ í˜ë¥´ì†Œë‚˜ ë°ì´í„°
  const defaultPersonas = {
    kim: {
      personality: 'ì°¨ë¶„í•˜ê³  ë…¼ë¦¬ì ì¸ ë³€í˜¸ì‚¬. ë²•ì  ê·¼ê±°ë¥¼ ëª…í™•íˆ ì œì‹œ. ì¡´ëŒ“ë§ ì‚¬ìš©.',
      expertise: 'ë…¸ë™ë²• ì†Œì†¡, ë¶€ë‹¹í•´ê³  êµ¬ì œ, ë…¸ë™ìœ„ì›íšŒ ëŒ€ë¦¬, ë²•ë¥  ìë¬¸',
      skills: ['ì†Œì†¡ ì „ëµ', 'ë²•ë¥  ìë¬¸', 'ë¶€ë‹¹í•´ê³  êµ¬ì œ', 'ë…¸ë™ìœ„ì›íšŒ ëŒ€ë¦¬', 'íŒë¡€ ë¶„ì„'],
      stats: { ë¶„ì„ë ¥: 96, ì‹¤í–‰ë ¥: 88, ì†Œí†µë ¥: 82, ì „ë¬¸ì„±: 98, ì°½ì˜ì„±: 60 }
    },
    park: {
      personality: 'ì‹¤ë¬´ ê²½í—˜ í’ë¶€í•œ ë…¸ë¬´ì‚¬. í˜„ì‹¤ì  í•´ê²°ì±… ì œì‹œ. í•´ìš”ì²´ ì‚¬ìš©.',
      expertise: 'ì·¨ì—…ê·œì¹™, ì¸ì‚¬ì œë„ ì„¤ê³„, ê·¼ë¡œê³„ì•½ì„œ, ì¸ì‚¬ë…¸ë¬´ ì»¨ì„¤íŒ…',
      skills: ['ì·¨ì—…ê·œì¹™ ì‘ì„±', 'ì¸ì‚¬ì œë„ ì„¤ê³„', 'ê·¼ë¡œê³„ì•½ì„œ ê²€í† ', 'ë…¸ë¬´ ì»¨ì„¤íŒ…', 'ì¸ì‚¬ê´€ë¦¬'],
      stats: { ë¶„ì„ë ¥: 88, ì‹¤í–‰ë ¥: 95, ì†Œí†µë ¥: 90, ì „ë¬¸ì„±: 92, ì°½ì˜ì„±: 72 }
    },
    oh: {
      personality: 'ì•ˆì „ ìµœìš°ì„  ì „ë¬¸ê°€. ì²´ê³„ì  ì„¤ëª…. í•©ì‡¼ì²´ ì‚¬ìš©. ë‹¨ë‹¨í•˜ê³  ì±…ì„ê° ìˆìŒ.',
      expertise: 'ì‚°ì—…ì•ˆì „ë³´ê±´ë²•, ì•ˆì „ë³´ê±´ê´€ë¦¬ì²´ê³„, ìœ„í—˜ì„±í‰ê°€, ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²•',
      skills: ['ìœ„í—˜ì„±í‰ê°€', 'ì•ˆì „ê´€ë¦¬ì²´ê³„ êµ¬ì¶•', 'ì¤‘ëŒ€ì¬í•´ë²• ëŒ€ì‘', 'ì•ˆì „êµìœ¡', 'ì‚¬ê³ ì¡°ì‚¬'],
      stats: { ë¶„ì„ë ¥: 90, ì‹¤í–‰ë ¥: 96, ì†Œí†µë ¥: 75, ì „ë¬¸ì„±: 95, ì°½ì˜ì„±: 55 }
    },
    lee: {
      personality: 'íŠ¸ë Œë””í•˜ê³  ê°ê°ì ì¸ MZì„¸ëŒ€ ë””ìì´ë„ˆ. ë°˜ë§. ì•„ì´ë””ì–´ ë„˜ì¹¨.',
      expertise: 'í”„ë ˆì  í…Œì´ì…˜, ë§ˆì¼€íŒ… ì½˜í…ì¸ , SNS ë””ìì¸, ë¸Œëœë”©',
      skills: ['ë¸Œëœë“œ ë””ìì¸', 'PPT ì œì‘', 'SNS ì½˜í…ì¸ ', 'ì¹´í”¼ë¼ì´íŒ…', 'íŠ¸ë Œë“œ ë¶„ì„'],
      stats: { ë¶„ì„ë ¥: 70, ì‹¤í–‰ë ¥: 88, ì†Œí†µë ¥: 92, ì „ë¬¸ì„±: 78, ì°½ì˜ì„±: 98 }
    },
    jung: {
      personality: 'ì •í™•í•œ ìˆ«ìì™€ ê³„ì‚°ì— ê°•í•œ ì„¸ë¬´ì‚¬. ì‹¤ë¬´ì  ë‹µë³€. ì¡´ëŒ“ë§ ì‚¬ìš©.',
      expertise: '4ëŒ€ë³´í—˜, ì›ì²œì§•ìˆ˜, ê¸‰ì—¬ì •ì‚°, í‡´ì§ê¸ˆ ì‚°ì •, ì„¸ë¬´ ì‹ ê³ ',
      skills: ['ê¸‰ì—¬ ì •ì‚°', '4ëŒ€ë³´í—˜ ì‹¤ë¬´', 'í‡´ì§ê¸ˆ ì‚°ì •', 'ì›ì²œì§•ìˆ˜', 'ì„¸ë¬´ ì‹ ê³ '],
      stats: { ë¶„ì„ë ¥: 98, ì‹¤í–‰ë ¥: 92, ì†Œí†µë ¥: 72, ì „ë¬¸ì„±: 95, ì°½ì˜ì„±: 50 }
    }
  };

  // â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€
  async function init() {
    const { hasKey } = await api.checkApiKey();
    if (!hasKey) document.getElementById('api-overlay').style.display = 'flex';

    employees = await api.getEmployees();
    employeePersonas = { ...defaultPersonas };

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    document.getElementById('chat-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    document.getElementById('chat-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    // ì§ì› ì „í™˜ ìˆ˜ì‹ 
    api.onSwitchEmployee(id => selectEmployee(id));
  }

  function selectEmployee(id) {
    const emp = employees.find(e => e.id === id);
    if (!emp) return;
    currentEmployee = emp;
    renderProfile(emp);
    renderChat(emp);
    renderPersona(emp);
    renderSkills(emp);
    switchTab('chat');
    document.getElementById('chat-input').focus();
  }

  function renderProfile(emp) {
    const section = document.getElementById('profile-section');
    const statusLabels = { working: 'ì—…ë¬´ ì¤‘', resting: 'íœ´ì‹ì¤‘', vacation: 'íœ´ê°€' };
    section.innerHTML = `
      <div class="profile-avatar" style="border-color: ${emp.color}40">
        ${createCharSVG(emp.id)}
      </div>
      <div class="profile-info">
        <div class="profile-name">${emp.name}</div>
        <div class="profile-role">${emp.role}</div>
        <div class="profile-status ${emp.status}" style="position:relative" onclick="toggleStatus()">
          <span class="status-dot-sm"></span>
          ${emp.statusLabel || statusLabels[emp.status]}
          <div class="status-menu-popup" id="status-popup">
            <button onclick="changeStatus('working', 'ì—…ë¬´ ì¤‘')">ğŸŸ¢ ì—…ë¬´ ì¤‘</button>
            <button onclick="changeStatus('resting', 'íœ´ì‹ì¤‘')">ğŸŸ¡ íœ´ì‹ì¤‘</button>
            <button onclick="changeStatus('vacation', 'íœ´ê°€')">ğŸ”´ íœ´ê°€</button>
          </div>
        </div>
      </div>
    `;
  }

  function toggleStatus() {
    document.getElementById('status-popup').classList.toggle('show');
  }

  async function changeStatus(status, label) {
    if (!currentEmployee) return;
    await api.setStatus(currentEmployee.id, status, label);
    currentEmployee.status = status;
    currentEmployee.statusLabel = label;
    renderProfile(currentEmployee);
  }

  // â”€â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€
  function switchTab(tab) {
    document.querySelectorAll('.dtab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.dtab[data-tab="${tab}"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
  }

  // â”€â”€â”€ ì±„íŒ… â”€â”€â”€
  function renderChat(emp) {
    const container = document.getElementById('chat-messages');
    const history = chatHistories[emp.id] || [];
    if (history.length === 0) {
      container.innerHTML = `<div class="chat-empty">${emp.name}ì—ê²Œ<br>ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”</div>`;
      return;
    }
    container.innerHTML = history.map(m => `
      <div class="msg ${m.role}">
        <div class="msg-bubble">${escapeHtml(m.text)}</div>
        <div class="msg-time">${m.time}</div>
      </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
  }

  // â”€â”€â”€ ì²¨ë¶€íŒŒì¼ â”€â”€â”€
  function toggleAttachMenu() {
    document.getElementById('attach-menu').classList.toggle('show');
  }

  function triggerFileInput(type) {
    currentFileType = type;
    const input = document.getElementById('file-input');
    input.accept = type === 'image' ? 'image/*' : '*/*';
    input.click();
    toggleAttachMenu();
  }

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const isImage = file.type.startsWith('image/');
      attachments.push({
        type: isImage ? 'image' : 'document',
        name: file.name,
        content: e.target.result
      });
      renderAttachments();
    };
    reader.readAsDataURL(file);
    event.target.value = '';
  }

  function addTextAttachment() {
    const text = prompt('í…ìŠ¤íŠ¸ ë©”ëª¨ ì…ë ¥:');
    if (text) {
      attachments.push({
        type: 'text',
        name: 'ë©”ëª¨',
        content: text
      });
      renderAttachments();
    }
    toggleAttachMenu();
  }

  function renderAttachments() {
    const container = document.getElementById('attachments-preview');
    container.innerHTML = attachments.map((a, i) => `
      <div class="attachment-chip">
        ${a.type === 'image' ? 'ğŸ–¼ï¸' : a.type === 'text' ? 'ğŸ“' : 'ğŸ“„'} ${a.name}
        <button class="remove-attach" onclick="removeAttachment(${i})">âœ•</button>
      </div>
    `).join('');
    container.classList.toggle('has-items', attachments.length > 0);
  }

  function removeAttachment(index) {
    attachments.splice(index, 1);
    renderAttachments();
  }

  // í´ë¦­ ì™¸ë¶€ì‹œ ë©”ë‰´ ë‹«ê¸°
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.attach-btn') && !e.target.closest('.attach-menu')) {
      document.getElementById('attach-menu')?.classList.remove('show');
    }
  });

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if ((!text && attachments.length === 0) || !currentEmployee || isLoading) return;

    isLoading = true;
    document.getElementById('send-btn').disabled = true;
    input.value = '';
    input.style.height = 'auto';

    const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

    // ë©”ì‹œì§€ + ì²¨ë¶€íŒŒì¼ í‘œì‹œ
    let displayText = text;
    if (attachments.length > 0) {
      const attachInfo = attachments.map(a => `ğŸ“ ${a.name}`).join(', ');
      displayText = text ? `${text}\n\n${attachInfo}` : attachInfo;
    }

    if (!chatHistories[currentEmployee.id]) chatHistories[currentEmployee.id] = [];
    chatHistories[currentEmployee.id].push({ role: 'user', text: displayText, time });

    const container = document.getElementById('chat-messages');
    const empty = container.querySelector('.chat-empty');
    if (empty) empty.remove();

    // ì‚¬ìš©ì ë©”ì‹œì§€
    appendMsg('user', displayText, time);

    // ì²¨ë¶€íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
    let messageToSend = text;
    if (attachments.length > 0) {
      const attachContext = attachments.map(a => {
        if (a.type === 'text') return `[í…ìŠ¤íŠ¸ ë©”ëª¨] ${a.content}`;
        if (a.type === 'image') return `[ì´ë¯¸ì§€ ì²¨ë¶€] ${a.name}`;
        return `[ë¬¸ì„œ ì²¨ë¶€] ${a.name}`;
      }).join('\n');
      messageToSend = `${text}\n\n[ì²¨ë¶€íŒŒì¼]\n${attachContext}`;
    }

    // ì²¨ë¶€ ì´ˆê¸°í™”
    attachments = [];
    renderAttachments();

    // íƒ€ì´í•‘ í‘œì‹œ
    const typingEl = document.createElement('div');
    typingEl.className = 'msg bot typing-msg';
    typingEl.innerHTML = `<div class="msg-bubble"><span></span><span></span><span></span></div>`;
    container.appendChild(typingEl);
    container.scrollTop = container.scrollHeight;

    const result = await api.sendMessage(currentEmployee.id, messageToSend);
    typingEl.remove();

    const replyTime = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

    if (result.error) {
      appendMsg('bot', `[ì˜¤ë¥˜] ${result.error}`, replyTime);
      chatHistories[currentEmployee.id].push({ role: 'bot', text: result.error, time: replyTime });
    } else {
      appendMsg('bot', result.reply, replyTime);
      chatHistories[currentEmployee.id].push({ role: 'bot', text: result.reply, time: replyTime });
    }

    isLoading = false;
    document.getElementById('send-btn').disabled = false;
  }

  function appendMsg(role, text, time) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerHTML = `<div class="msg-bubble">${escapeHtml(text)}</div><div class="msg-time">${time}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

  // â”€â”€â”€ í˜ë¥´ì†Œë‚˜ â”€â”€â”€
  function renderPersona(emp) {
    const p = employeePersonas[emp.id] || {};
    document.getElementById('persona-personality').value = p.personality || '';
    document.getElementById('persona-expertise').value = p.expertise || '';
    document.getElementById('persona-system').value = emp.systemPrompt || '';
  }

  // â”€â”€â”€ ëŠ¥ë ¥/ìŠ¤í‚¬ â”€â”€â”€
  function renderSkills(emp) {
    const p = employeePersonas[emp.id] || {};
    const stats = p.stats || {};
    const skills = p.skills || [];

    // ëŠ¥ë ¥ì¹˜ ë°”
    const statColors = { ë¶„ì„ë ¥: '#3498DB', ì‹¤í–‰ë ¥: '#2ECC71', ì†Œí†µë ¥: '#E67E22', ì „ë¬¸ì„±: '#9B59B6', ì°½ì˜ì„±: '#E74C3C' };
    document.getElementById('stat-bars').innerHTML = Object.entries(stats).map(([k, v]) => `
      <div class="stat-row">
        <span class="stat-label">${k}</span>
        <div class="stat-bar-bg">
          <div class="stat-bar-fill" style="width:${v}%; background:${statColors[k] || '#6c5ce7'}"></div>
        </div>
        <span class="stat-value" style="color:${statColors[k] || '#6c5ce7'}">${v}</span>
      </div>
    `).join('');

    // ìŠ¤í‚¬ íƒœê·¸
    document.getElementById('skill-tags').innerHTML = skills.map((s, i) => `
      <div class="skill-tag">
        ${s}
        <span class="remove" onclick="removeSkill(${i})">Ã—</span>
      </div>
    `).join('');
  }

  function addSkill() {
    const input = document.getElementById('new-skill-input');
    const skill = input.value.trim();
    if (!skill || !currentEmployee) return;
    if (!employeePersonas[currentEmployee.id]) employeePersonas[currentEmployee.id] = { skills: [] };
    if (!employeePersonas[currentEmployee.id].skills) employeePersonas[currentEmployee.id].skills = [];
    employeePersonas[currentEmployee.id].skills.push(skill);
    input.value = '';
    renderSkills(currentEmployee);
  }

  function removeSkill(idx) {
    if (!currentEmployee) return;
    employeePersonas[currentEmployee.id].skills.splice(idx, 1);
    renderSkills(currentEmployee);
  }

  // â”€â”€â”€ API í‚¤ â”€â”€â”€
  async function submitApiKey() {
    const key = document.getElementById('api-key-input').value.trim();
    if (key) {
      const { success } = await api.setApiKey(key);
      if (success) document.getElementById('api-overlay').style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
